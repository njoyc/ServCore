{% extends "base.html" %}
{% block title %}Agent Dashboard - ServCore{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Agent Dashboard - {{ current_user.name }}</h1>
</div>

<!-- ================= STATS ================= -->
<div class="stats-grid">
    <div class="stat-card stat-primary">
        <h3>Assigned to Me</h3>
        <div class="stat-value">{{ total_assigned }}</div>
    </div>

    <div class="stat-card stat-warning">
        <h3>In Progress</h3>
        <div class="stat-value">{{ in_progress_count }}</div>
    </div>

    <div class="stat-card stat-success">
        <h3>Resolved Today</h3>
        <div class="stat-value">{{ resolved_today }}</div>
    </div>

    <div class="stat-card {% if overdue_count > 0 %}stat-danger{% else %}stat-success{% endif %}">
        <h3>Overdue Tickets</h3>
        <div class="stat-value">{{ overdue_count }}</div>
    </div>
</div>

<!-- ================= ASSIGNED ================= -->
<div class="card">
    <div class="card-header">
        <h2>My Assigned Tickets</h2>
    </div>

    {% if assigned_tickets %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Created</th>
                <th>SLA</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in assigned_tickets %}
            <tr onclick="window.location='{{ url_for('tickets.view_ticket', id=ticket.id) }}'">
                <td>#{{ ticket.id }}</td>
                <td>{{ ticket.title }}</td>
                <td><span class="badge priority-{{ ticket.priority.lower() }}">{{ ticket.priority }}</span></td>
                <td><span class="badge status-{{ ticket.status.lower() }}">{{ ticket.status }}</span></td>
                <td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    {% if ticket.is_overdue() %}
                        <span class="sla-indicator sla-overdue">Overdue</span>
                    {% else %}
                        <span class="sla-indicator sla-ok">Within SLA</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center">No assigned tickets.</p>
    {% endif %}
</div>

<!-- ================= UNASSIGNED ================= -->
<div class="card">
    <div class="card-header">
        <h2>Unassigned Tickets (Request Approval Required)</h2>
    </div>

    {% if unassigned_tickets %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Category</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Created</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in unassigned_tickets %}
            <tr>
                <td>#{{ ticket.id }}</td>
<td>
   {% if ticket.assigned_to %}
    <a href="{{ url_for('tickets.view_ticket', id=ticket.id) }}">
        {{ ticket.title }}
    </a>
{% else %}
    <span class="text-muted">{{ ticket.title }}</span>
{% endif %}

</td>

<td>
    <span class="badge category-{{ ticket.category.lower() }}">
        {{ ticket.category }}
    </span>
</td>
<td>
    <span class="badge priority-{{ ticket.priority.lower() }}">
        {{ ticket.priority }}
    </span>
</td>
<td>
    <span class="badge status-{{ ticket.status.lower() }}">
        {{ ticket.status }}
    </span>
</td>
<td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
<td>

                    {% if ticket.can_request %}
                        {% if ticket.request_pending %}
                            <span class="badge badge-warning">Request Pending</span>
                        {% else %}
                            <form method="POST"
                                  action="{{ url_for('tickets.request_assignment', id=ticket.id) }}">
                                <button class="btn btn-sm btn-primary">
                                    Request Assignment
                                </button>
                            </form>
                        {% endif %}
                    {% else %}
                        <span class="badge badge-secondary">Waiting (24h rule)</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center">No unassigned tickets.</p>
    {% endif %}
</div>
{% endblock %}
